buildscript {
    repositories {
        maven { url = 'https://maven.minecraftforge.net' }
        mavenCentral()
    }
    dependencies {
        classpath group: 'net.minecraftforge.gradle', name: 'ForgeGradle', version: '5.1.+', changing: true
    }
}

plugins {
    id 'java'
    id 'io.freefair.lombok' version '6.3.0'
    id 'org.ajoberstar.grgit' version '5.0.0'
    id 'wtf.gofancy.fancygradle' version '1.+'
    id 'se.bjurr.gitchangelog.git-changelog-gradle-plugin' version '1.+'
}

apply plugin: 'net.minecraftforge.gradle'

java.toolchain.languageVersion = JavaLanguageVersion.of(8)
lombok.version = "1.18.22"

ext {
	IS_SNAPSHOT = false
}

// Produces a version string based on if we are building a snapshot or not
// Example: if IS_SNAPSHOT = true
// 1.12.2-4.0.2-snapshot.fd97d04
def getVersion = {
	def hash = grgit.head().abbreviatedId.toString()
	return "${mc_version}-${version_full}${t -> if (IS_SNAPSHOT) t << '-snapshot.' + hash}".toString()
}

version = getVersion()
group = "micdoodle8.mods.galacticraft"
archivesBaseName = "Galacticraft"

ext {
	MANIFEST = manifest{
        attributes([
            'Specification-Title'         : 'Galacticraft',
            'Specification-Vendor'        : 'TeamGalacticraft',
            'Specification-Version'       : version.split("-")[1],
            'Implementation-Title'        : project.group,
            'Implementation-Version'      : version.split("-")[1],
            'Implementation-Vendor'       : 'Galacticraft',
            'Implementation-Timestamp'    : new Date().format("yyyy-MM-dd'T'HH:mm:ssZ"),
            'FMLAT'                       : 'accesstransformer.cfg',
            'FMLCorePluginContainsFMLMod' : 'true',
            'FMLCorePlugin'               : 'micdoodle8.mods.miccore.MicdoodlePlugin',
            'Build-Against'				  : "Forge: ${forge_version}",
            'Built-Using'				  : "ForgeGradle: 5.1.+",
            'Git-Commit'				  : grgit.head().abbreviatedId,
            'Git-Branch'                  : grgit.branch.current().getName()
        ] as LinkedHashMap)
    }
}

apply from: 'gradle/minecraft.gradle'

task generateChangelog(type: se.bjurr.gitchangelog.plugin.gradle.GitChangelogTask) {
    group = 'script-tasks'
    description = 'Generates Changelog'

    fromRepo = file(".");
    settingsFile = file("changelog.json").getAbsolutePath();
    file = file("${projectDir}/CHANGELOG-${project.version}.md");
    templateContent = file('changelog.mustache').getText('UTF-8');
}

jar {
    manifest.from(MANIFEST)
}

jar.finalizedBy('reobfJar')

task sourcesJar(type: Jar, dependsOn: classes) {
	classifier = 'sources'
    from sourceSets.main.allSource
    manifest.from(MANIFEST)
}

task apiJar(type: Jar) {
    classifier "api"
    include 'micdoodle8/mods/galacticraft/api/**'
    from sourceSets.main.allJava
    from sourceSets.main.output
    manifest.from(MANIFEST)
}

task deobfJar(type: Jar) {
	classifier = 'deobf'
    from sourceSets.main.output
    manifest.from(MANIFEST)
}

artifacts {
    archives deobfJar
    archives sourcesJar
    archives apiJar
}

apply from: 'gradle/maven.gradle'
apply from: 'gradle/resources.gradle'

clean {
    def filteredDelete = new HashSet<>()
    for (def toDelete : getDelete()) {
        for (def f : file(toDelete).listFiles()) {
            if (f.getName() != "fg_cache") {
                filteredDelete.add(f)
            }
        }
    }
    setDelete(filteredDelete)
}